# 動体検知プログラム (Motion-Detection-App)

本アプリは OpenCV を用いた**動体検知の学習用**プログラムです。処理はシンプルですが、実務でも定番のパイプライン（背景差分 → 二値化 → 形態学的処理 → 輪郭抽出 → 事象判定）をひと通り体験できます。<br>
※ 実装詳細はコード内コメント、理論は本 README の「理論的背景」を参照してください。

**動作環境**: Python / OpenCV (`opencv-python`)

---

## 理論的背景

本プログラムは次の5段階で、連続フレームにおける“動き”を**1つのイベント**として数え上げます。

1. 背景差分
2. 大津の二値化（Otsu）
3. 形態学的処理（開演算＋膨張）
4. 輪郭抽出（面積しきい値）
5. 事象判定（状態機械）

---

### 1. 背景モデル（指数移動平均 / アルファブレンディング）

フレーム (I_t) と背景モデル (B_t) の指数移動平均（EMA）で背景を更新します。

[
B_t \leftarrow (1-\alpha),B_{t-1} + \alpha,I_t
]

* (\alpha)（= `LEARN_RATE`）が大きいほど**最新フレームを強く反映**し、照度変化に追従しやすくなります（ただし“ゆっくり動く物体”は背景に溶けやすい）。
* 差分画像は (D_t = |I_t - B_t|)。背景からの逸脱量を表し、動き候補になります。
* 初期の数十フレームは**ウォームアップ**として背景学習を優先します（`WARMUP_FRAMES`）。

---

### 2. 前処理（平滑化）

`GaussianBlur(7×7)` により高周波ノイズを抑え、のちの二値化・輪郭抽出を安定化させます。
カーネルを大きくするとノイズに強くなりますが、細い構造は痩せるため `AREA_MIN` とのバランス調整が必要です。

---

### 3. 大津の二値化（Otsu）

差分 (D_t) のヒストグラムが**背景**と**動き**の二峰性を持つと仮定し、**クラス内分散**を最小化（≒クラス間分散最大化）する**最適なしきい値** (T^*) を求めます。
強い照度変動や反射で分布が崩れる場合は、適応的二値化や背景学習率の調整を検討します。

---

### 4. 形態学的処理（Morphology）

二値画像に対する集合演算で、**3×3 の構造要素**（正方）を使用します。

* **開演算（Opening）**：
  [
  \mathrm{Open}(A) = (A \ominus S) \oplus S
  ]
  まず侵食で**小粒ノイズを除去**し、その後の膨張で太さを戻します。孤立点やヒゲ状ノイズに有効です（冪等）。

* **追加の膨張（Dilation）**：
  [
  A \oplus S
  ]
  小さな切れ目や穴を**埋めて連結性を回復**します。
  → 「ひとまとまり」の領域として面積評価しやすくなります。

> 調整の要点：
>
> * 小粒ノイズが多い → `kernel` を大きく（`5×5`） or `Open` の `iterations` を増加
> * 分断されやすい → `Open` を弱め、**膨張**の回数を増やす
> * 過膨張で太り過ぎ → 膨張回数を減らす／`kernel` を小さく

---

### 5. 輪郭抽出

`findContours` で外接輪郭を抽出し、各輪郭の面積 (\mathcal{A}) を算出します。
**面積しきい値 `AREA_MIN`** 以上の輪郭が1つでもあれば、そのフレームを**“動きあり”**と判定します。
（点在する小領域が多い場合は**合計面積**で判定する方法も有効です。）

---

### ROI（関心領域）

ROI は画像の一部だけを解析する**空間的制約**です。

* 計算量削減と**誤検知率の低下**に有効。
* ただし **小さすぎる／画面外にはみ出す** と統計が破綻します。最小幅・高さ（`MIN_ROI_W/H`）を設け、フレーム内にクリップしています。

---

### 事象判定（状態機械）

フレーム単位の true/false をそのまま数えると**ちらつき**で過大カウントになりがちです。
そこで**立ち上がり・静穏・最小間隔**を持つ状態機械で「1回の動き＝1イベント」に正規化します。

* **立ち上がり（START）**：
  「動きあり」が **P 枚連続**（`PERSIST_FRAMES`） → **イベント開始（+1）**
* **静穏（END）**：
  「動きなし」が **Q 枚連続**（`QUIET_FRAMES`） → **イベント終了**
* **最小イベント間隔**：
  前回開始から **G フレーム未満**（`MIN_EVENT_GAP_S × fps`）は**不感帯**として無視

> チューニング指針：
>
> * 過剰カウント → P/Q/G を**増やす**、`AREA_MIN` を**上げる**
> * 見逃しが多い → P/Q/G を**下げる**、`AREA_MIN` を**下げる**

---

## 用語メモ（最少）

* **EMA（指数移動平均）**：時間方向の平滑化（背景学習）。
* **Otsu**：ヒストグラム二峰性を仮定した最適なしきい値決定。
* **形態学（開/閉/侵食/膨張）**：二値画像の**ノイズ除去**と**連結性の制御**。
* **ROI**：解析範囲。十分なサイズを確保する。
* **状態機械**：時間方向の**デバウンス**で“1イベント”に正規化。